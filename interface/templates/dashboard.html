<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NOVA II ‚Äî Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/dashboard/static/dashboard.css">
</head>

<body>

    <!-- Header -->
    <div class="header">
        <h1>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ <span>‡πÄ‡∏ö‡∏ô</span>! üëã</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="refreshData()" title="Refresh">üîÑ</button>
            <a class="header-btn" href="/dashboard/logout" title="Logout">üö™</a>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê HOME TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-home" class="tab-content active">

        <!-- Stat Cards -->
        <div class="stat-cards">
            <div class="stat-card" onclick="switchTab('goals')">
                <div class="icon">üéØ</div>
                <div class="number" id="stat-goals">-</div>
                <div class="label">Active Goals</div>
            </div>
            <div class="stat-card" onclick="switchTab('goals')">
                <div class="icon">‚úÖ</div>
                <div class="number" id="stat-tasks">-</div>
                <div class="label">Tasks Done</div>
            </div>
            <div class="stat-card" onclick="switchTab('kb')">
                <div class="icon">üìù</div>
                <div class="number" id="stat-kb">-</div>
                <div class="label">Notes</div>
            </div>
        </div>

        <!-- Active Goals Preview -->
        <div class="section-header">
            <h2>üéØ Active Goals</h2>
            <span class="see-all" onclick="switchTab('goals')">See all ‚Üí</span>
        </div>
        <div id="home-goals" class="goal-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>

        <!-- Upcoming Events -->
        <div class="section-header">
            <h2>üìÖ Upcoming Events</h2>
            <span class="see-all" onclick="switchTab('chat')">Chat ‚Üí</span>
        </div>
        <div id="home-calendar" class="calendar-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GOALS TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-goals" class="tab-content">
        <div class="section-header">
            <h2>üéØ Goals & Tasks</h2>
            <button class="primary-btn" onclick="openGoalModal()">+ New Goal</button>
        </div>
        <div id="goals-list" class="goal-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê KB TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-kb" class="tab-content">
        <div class="section-header">
            <h2>üìù Knowledge Base</h2>
        </div>
        <div class="kb-controls">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-bar" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ô‡πâ‡∏ï..." id="kb-search"
                    oninput="debounceSearch()">
            </div>
        </div>
        <div class="filter-pills" id="kb-filters">
            <button class="pill active" onclick="filterKB('All')">All</button>
        </div>
        <div id="kb-list" class="kb-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CHAT TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-chat" class="tab-content">
        <div class="chat-container">
            <div class="chat-header-bar">
                <h2>üí¨ Chat with NOVA</h2>
                <span class="chat-status" id="chat-status">Online</span>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-welcome">
                    <div class="chat-welcome-icon">ü§ñ</div>
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡πÇ‡∏ô‡∏ß‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞</p>
                    <span class="chat-welcome-hint">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÇ‡∏ô‡∏ß‡πà‡∏≤</span>
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                <div class="typing-avatar">ü§ñ</div>
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span class="typing-text">‡πÇ‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</span>
            </div>
            <div class="chat-input-area">
                <textarea id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"
                    onkeydown="handleChatKey(event)"></textarea>
                <button class="chat-send-btn" id="chat-send-btn" onclick="sendMessage()">
                    <span>‚û§</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SETTINGS TAB ‚ïê‚ïê‚ïê -->
    <div id="tab-settings" class="tab-content">
        <div class="section-header">
            <h2>‚öôÔ∏è Settings</h2>
        </div>
        <div class="settings-list">
            <div class="settings-item">
                <span class="label">üìä Total Goals</span>
                <span class="value" id="set-total-goals">-</span>
            </div>
            <div class="settings-item">
                <span class="label">‚úÖ Tasks Completed</span>
                <span class="value" id="set-done-tasks">-</span>
            </div>
            <div class="settings-item">
                <span class="label">üìù Knowledge Entries</span>
                <span class="value" id="set-kb-count">-</span>
            </div>
            <div class="settings-item">
                <span class="label">üïê Last Updated</span>
                <span class="value" id="set-last-update">-</span>
            </div>
            <div class="settings-item">
                <span class="label">ü§ñ System</span>
                <span class="value">NOVA II v2.0</span>
            </div>
        </div>
        <a href="/dashboard/logout" class="logout-btn">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>

    <!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
    <div id="goal-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeGoalModal()">&times;</span>
            <h2>üéØ New Goal</h2>
            <form id="goal-form" onsubmit="submitGoal(event)">
                <div class="form-group">
                    <label>Goal Name</label>
                    <input type="text" id="goal-name" required placeholder="e.g. Learn Python">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="goal-desc" rows="3" placeholder="Details..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="goal-due">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="goal-priority">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="goal-auto">
                    <label for="goal-auto">‚ú® AI Auto-Breakdown tasks</label>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="primary-btn">Create Goal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" onclick="switchTab('goals')">
            <span class="nav-icon">üéØ</span>
            <span class="nav-label">Goals</span>
        </button>
        <button class="nav-item" onclick="switchTab('kb')">
            <span class="nav-icon">üìù</span>
            <span class="nav-label">KB</span>
        </button>
        <button class="nav-item" onclick="switchTab('chat')">
            <span class="nav-icon">üí¨</span>
            <span class="nav-label">Chat</span>
        </button>
        <button class="nav-item" onclick="switchTab('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <script>
        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
        let currentTab = 'home';
        let goalsData = [];
        let kbData = [];
        let currentCategoryFilter = 'All';
        let searchTimeout = null;

        let chatLoaded = false;

        // ‚îÄ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabOrder = ['home', 'goals', 'kb', 'chat', 'settings'];
            document.querySelectorAll('.nav-item')[tabOrder.indexOf(tab)].classList.add('active');

            // Load data on first visit
            if (tab === 'goals' && !document.getElementById('goals-list').querySelector('.goal-card')) {
                loadGoals('goals-list', false);
            }
            if (tab === 'kb' && !document.getElementById('kb-list').querySelector('.kb-card')) {
                loadKB();
            }
            if (tab === 'chat' && !chatLoaded) {
                loadChatHistory();
                chatLoaded = true;
            }
        }

        // ‚îÄ‚îÄ‚îÄ API Calls ‚îÄ‚îÄ‚îÄ
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(endpoint);
                if (res.status === 401 || res.status === 302) {
                    window.location.href = '/dashboard/login';
                    return null;
                }
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        }

        // ‚îÄ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ‚îÄ
        async function loadStats() {
            const data = await fetchAPI('/api/stats');
            if (!data || !data.success) return;

            const s = data.stats;
            document.getElementById('stat-goals').textContent = s.active_goals;
            document.getElementById('stat-tasks').textContent = `${s.done_tasks}/${s.total_tasks}`;
            document.getElementById('stat-kb').textContent = s.kb_entries;

            // Settings
            document.getElementById('set-total-goals').textContent = s.total_goals;
            document.getElementById('set-done-tasks').textContent = `${s.done_tasks}/${s.total_tasks}`;
            document.getElementById('set-kb-count').textContent = s.kb_entries;

            const now = new Date();
            document.getElementById('set-last-update').textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        }

        // ‚îÄ‚îÄ‚îÄ Load Calendar ‚îÄ‚îÄ‚îÄ
        async function loadCalendar() {
            const container = document.getElementById('home-calendar');
            const data = await fetchAPI('/api/calendar?days=7');

            if (!data || !data.success || !data.events || data.events.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><p>‡πÑ‡∏°‡πà‡∏°‡∏µ events ‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞</p></div>';
                return;
            }

            container.innerHTML = '';
            let currentDate = null;

            data.events.forEach(event => {
                const start = event.start;
                let dateLabel, timeLabel;

                if (event.all_day) {
                    const dt = new Date(start + 'T00:00:00');
                    dateLabel = dt.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                    timeLabel = '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
                } else {
                    const dt = new Date(start);
                    dateLabel = dt.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                    const endDt = new Date(event.end);
                    timeLabel = dt.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) + ' - ' + endDt.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                }

                if (dateLabel !== currentDate) {
                    currentDate = dateLabel;
                    container.innerHTML += `<div class="calendar-date-header">üìÜ ${dateLabel}</div>`;
                }

                const loc = event.location ? `<div class="calendar-location">üìç ${event.location}</div>` : '';
                container.innerHTML += `
                    <div class="calendar-event-card">
                        <div class="calendar-event-time">${timeLabel}</div>
                        <div class="calendar-event-info">
                            <div class="calendar-event-title">${event.summary}</div>
                            ${loc}
                        </div>
                    </div>
                `;
            });
        }

        // ‚îÄ‚îÄ‚îÄ Load Goals ‚îÄ‚îÄ‚îÄ
        async function loadGoals(containerId, limitToActive = true) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            const data = await fetchAPI('/api/goals');
            if (!data || !data.success) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞</p></div>';
                return;
            }

            goalsData = data.goals;
            let goals = goalsData;
            if (limitToActive) {
                goals = goals.filter(g => g.status === 'Active');
            }

            if (goals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ goals ‡∏Ñ‡πà‡∏∞<br>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p></div>';
                return;
            }

            container.innerHTML = goals.map(goal => renderGoalCard(goal)).join('');
        }

        function renderGoalCard(goal) {
            const daysLeft = goal.due_date ? getDaysLeft(goal.due_date) : null;
            const daysText = daysLeft !== null
                ? (daysLeft < 0 ? `‚è∞ ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`
                    : daysLeft === 0 ? '‚è∞ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!'
                        : `‚è∞ ‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô`)
                : '';

            const urgencyClass = goal.urgency || 'normal';
            const urgencyLabels = { normal: 'On Track', warning: 'Soon', urgent: 'Urgent', overdue: 'Overdue' };

            const tasksHTML = (goal.tasks || []).map(task => {
                const isDone = task.status === 'Done';
                const statusClass = isDone ? 'done' : task.status === 'In Progress' ? 'in-progress' : 'todo';

                return `<div class="task-item">
                <div class="task-checkbox ${isDone ? 'checked' : ''}" onclick="event.stopPropagation(); toggleTaskStatus('${task.id}', '${task.status}')">
                    ${isDone ? '‚úì' : ''}
                </div>
                <span class="task-name ${isDone ? 'done' : ''}">${escapeHTML(task.name)}</span>
                <span class="task-delete" onclick="event.stopPropagation(); deleteTask('${task.id}')">√ó</span>
            </div>`;
            }).join('');

            return `<div class="goal-card" onclick="toggleGoal(this)">
            <div class="goal-header">
                <span class="goal-name">${escapeHTML(goal.name)}</span>
                <div class="goal-actions">
                     <span class="urgency-badge ${urgencyClass}">${urgencyLabels[urgencyClass]}</span>
                     <div class="menu-dots" onclick="event.stopPropagation(); showGoalMenu(this, '${goal.id}')">‚ãÆ</div>
                </div>
            </div>
            <div class="goal-meta">
                ${goal.due_date ? `<span>üìÖ ${formatDate(goal.due_date)}</span>` : ''}
                <span>${daysText}</span>
                <span>üìå ${goal.status}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${goal.progress}%"></div>
            </div>
            <div class="progress-text">${goal.tasks_done}/${goal.tasks_total} tasks completed ¬∑ ${goal.progress}%</div>
            
            ${goal.tasks ? `
                <div class="task-list">
                    ${tasksHTML}
                    <div class="quick-add-task" onclick="event.stopPropagation()">
                        <input type="text" placeholder="+ Add task..." onkeydown="if(event.key==='Enter') addTask(this, '${goal.id}')">
                    </div>
                </div>
            ` : ''}
        </div>`;
        }

        function toggleGoal(el) {
            el.classList.toggle('expanded');
        }

        // ‚îÄ‚îÄ‚îÄ Load KB ‚îÄ‚îÄ‚îÄ
        async function loadKB() {
            const container = document.getElementById('kb-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            const search = document.getElementById('kb-search').value;
            const params = new URLSearchParams();
            if (currentCategoryFilter !== 'All') params.set('category', currentCategoryFilter);
            if (search) params.set('search', search);

            const data = await fetchAPI(`/api/kb?${params}`);
            if (!data || !data.success) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞</p></div>';
                return;
            }

            kbData = data.entries;

            // Update filter pills
            const filterContainer = document.getElementById('kb-filters');
            const categories = ['All', ...(data.categories || [])];
            filterContainer.innerHTML = categories.map(cat =>
                `<button class="pill ${cat === currentCategoryFilter ? 'active' : ''}" onclick="filterKB('${cat}')">${cat}</button>`
            ).join('');

            if (kbData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ô‡πâ‡∏ï‡∏Ñ‡πà‡∏∞</p></div>';
                return;
            }

            container.innerHTML = kbData.map(entry => renderKBCard(entry)).join('');
        }

        function renderKBCard(entry) {
            const catClass = (entry.category || 'other').toLowerCase();
            return `<div class="kb-card" onclick="this.classList.toggle('expanded')">
            <div class="kb-header">
                <span class="kb-title">${escapeHTML(entry.title)}</span>
                <span class="category-badge ${catClass}">${escapeHTML(entry.category || 'Other')}</span>
            </div>
            <div class="kb-content">${escapeHTML(entry.content || '')}</div>
            <div class="kb-date">üïê ${formatDateTime(entry.created_at)}</div>
        </div>`;
        }

        function filterKB(category) {
            currentCategoryFilter = category;
            loadKB();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadKB(), 300);
        }

        // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
        function getDaysLeft(dateStr) {
            const due = new Date(dateStr);
            const now = new Date();
            return Math.ceil((due - now) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ‚îÄ Chat Functions ‚îÄ‚îÄ‚îÄ
        async function loadChatHistory() {
            const container = document.getElementById('chat-messages');
            const data = await fetchAPI('/api/chat/history');
            if (!data || !data.success || !data.messages || data.messages.length === 0) return;

            // Clear welcome message
            container.innerHTML = '';

            // Messages come newest-first from API, reverse for chronological display
            const messages = data.messages.reverse();
            messages.forEach(msg => {
                container.appendChild(createMessageBubble(msg.role, msg.message, msg.created_at));
            });
            scrollToBottom();
        }

        function createMessageBubble(role, text, timestamp) {
            const wrapper = document.createElement('div');
            wrapper.className = `chat-bubble-wrapper ${role === 'user' ? 'user' : 'nova'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'user' : 'nova'}`;
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'chat-time';
            time.textContent = timestamp ? formatChatTime(timestamp) : 'just now';

            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            return wrapper;
        }

        function formatChatTime(dateStr) {
            const d = new Date(dateStr);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
            if (diffMins < 60) return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;

            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const container = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('chat-send-btn');

            // Clear welcome if present
            const welcome = container.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            // Add user bubble
            container.appendChild(createMessageBubble('user', message));
            input.value = '';
            autoResizeInput();
            scrollToBottom();

            // Show typing indicator
            document.getElementById('typing-indicator').style.display = 'flex';
            document.getElementById('chat-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...';
            document.getElementById('chat-status').classList.add('thinking');
            sendBtn.disabled = true;
            input.disabled = true;
            scrollToBottom();

            // Send to API
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (res.status === 401 || res.status === 302) {
                    window.location.href = '/dashboard/login';
                    return;
                }

                const data = await res.json();

                // Hide typing
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('chat-status').textContent = 'Online';
                document.getElementById('chat-status').classList.remove('thinking');

                if (data.success) {
                    container.appendChild(createMessageBubble('assistant', data.reply, data.timestamp));
                } else {
                    container.appendChild(createMessageBubble('assistant', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ñ‡πà‡∏∞: ' + (data.error || 'Unknown error')));
                }
            } catch (e) {
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('chat-status').textContent = 'Online';
                document.getElementById('chat-status').classList.remove('thinking');
                container.appendChild(createMessageBubble('assistant', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞'));
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
                scrollToBottom();
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeInput() {
            const input = document.getElementById('chat-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }

        // Auto-resize on input
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) chatInput.addEventListener('input', autoResizeInput);
        });

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }

        // ‚îÄ‚îÄ‚îÄ Interactive Functions ‚îÄ‚îÄ‚îÄ

        function openGoalModal() {
            document.getElementById('goal-modal').style.display = 'flex';
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').style.display = 'none';
        }

        async function submitGoal(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = 'Creating...';
            btn.disabled = true;

            const payload = {
                name: document.getElementById('goal-name').value,
                description: document.getElementById('goal-desc').value,
                due_date: document.getElementById('goal-due').value,
                priority: document.getElementById('goal-priority').value,
                auto_breakdown: document.getElementById('goal-auto').checked
            };

            try {
                const res = await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success || data.goal_id) {
                    closeGoalModal();
                    e.target.reset();
                    refreshData();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Connection error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function toggleTaskStatus(taskId, currentStatus) {
            const newStatus = currentStatus === 'Done' ? 'Todo' : 'Done';
            // Optimistic update would be good here, but for simplicity just waiting for API
            try {
                await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                // Reload specifically goals list to reflect progress
                loadGoals('goals-list', false);
                loadGoals('home-goals', true);
                loadStats();
            } catch (e) {
                console.error(e);
            }
        }

        async function addTask(input, goalId) {
            const name = input.value.trim();
            if (!name) return;

            input.disabled = true;
            try {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal_id: goalId, name: name })
                });
                input.value = '';
                refreshData();
            } catch (e) {
                alert('Failed to add task');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function deleteGoal(goalId) {
            if (!confirm('Are you sure you want to delete this goal?')) return;
            try {
                await fetch(`/api/goals/${goalId}`, { method: 'DELETE' });
                refreshData();
            } catch (e) {
                alert('Failed to delete goal');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            try {
                await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                refreshData();
            } catch (e) {
                alert('Failed to delete task');
            }
        }

        function showGoalMenu(icon, goalId) {
            // Simple confirm for delete for now, strictly per requirements/plan
            // Enhancing to full dropdown later if needed
            // For now, let's just trigger delete or edit via simple prompt
            // Or better: show a native confirm "Edit or Delete?" - actually standard generic delete is fine

            // NOTE: For better UX, we'd use a custom dropdown. 
            // For MVP speed: just confirm delete.
            deleteGoal(goalId);
        }

        // ‚îÄ‚îÄ‚îÄ Refresh ‚îÄ‚îÄ‚îÄ
        async function refreshData() {
            await Promise.all([loadStats(), loadGoals('home-goals', true), loadCalendar()]);
            if (currentTab === 'goals') await loadGoals('goals-list', false);
            if (currentTab === 'kb') await loadKB();
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadGoals('home-goals', true);
            loadCalendar();
        });
    </script>
</body>

</html>