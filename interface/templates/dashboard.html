<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NOVA II â€” Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/dashboard/static/dashboard.css">
</head>

<body>

    <!-- Header -->
    <div class="header">
        <h1>à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° <span>à¹€à¸šà¸™</span>! ğŸ‘‹</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="refreshData()" title="Refresh">ğŸ”„</button>
            <a class="header-btn" href="/dashboard/logout" title="Logout">ğŸšª</a>
        </div>
    </div>

    <!-- â•â•â• HOME TAB â•â•â• -->
    <div id="tab-home" class="tab-content active">

        <!-- Stat Cards -->
        <div class="stat-cards">
            <div class="stat-card" onclick="switchTab('goals')">
                <div class="icon">ğŸ¯</div>
                <div class="number" id="stat-goals">-</div>
                <div class="label">Active Goals</div>
            </div>
            <div class="stat-card" onclick="switchTab('goals')">
                <div class="icon">âœ…</div>
                <div class="number" id="stat-tasks">-</div>
                <div class="label">Tasks Done</div>
            </div>
            <div class="stat-card" onclick="switchTab('kb')">
                <div class="icon">ğŸ“</div>
                <div class="number" id="stat-kb">-</div>
                <div class="label">Notes</div>
            </div>
        </div>

        <!-- Active Goals Preview -->
        <div class="section-header">
            <h2>ğŸ¯ Active Goals</h2>
            <span class="see-all" onclick="switchTab('goals')">See all â†’</span>
        </div>
        <div id="home-goals" class="goal-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- â•â•â• GOALS TAB â•â•â• -->
    <div id="tab-goals" class="tab-content">
        <div class="section-header">
            <h2>ğŸ¯ Goals & Tasks</h2>
        </div>
        <div id="goals-list" class="goal-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- â•â•â• KB TAB â•â•â• -->
    <div id="tab-kb" class="tab-content">
        <div class="section-header">
            <h2>ğŸ“ Knowledge Base</h2>
        </div>
        <div class="kb-controls">
            <div class="search-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-bar" placeholder="à¸„à¹‰à¸™à¸«à¸²à¹‚à¸™à¹‰à¸•..." id="kb-search"
                    oninput="debounceSearch()">
            </div>
        </div>
        <div class="filter-pills" id="kb-filters">
            <button class="pill active" onclick="filterKB('All')">All</button>
        </div>
        <div id="kb-list" class="kb-list">
            <div class="loading">
                <div class="spinner"></div>Loading...
            </div>
        </div>
    </div>

    <!-- â•â•â• CHAT TAB â•â•â• -->
    <div id="tab-chat" class="tab-content">
        <div class="chat-container">
            <div class="chat-header-bar">
                <h2>ğŸ’¬ Chat with NOVA</h2>
                <span class="chat-status" id="chat-status">Online</span>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-welcome">
                    <div class="chat-welcome-icon">ğŸ¤–</div>
                    <p>à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°! à¹‚à¸™à¸§à¹ˆà¸²à¸à¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°</p>
                    <span class="chat-welcome-hint">à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹à¸Šà¸—à¸à¸±à¸šà¹‚à¸™à¸§à¹ˆà¸²</span>
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                <div class="typing-avatar">ğŸ¤–</div>
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span class="typing-text">à¹‚à¸™à¸§à¹ˆà¸²à¸à¸³à¸¥à¸±à¸‡à¸„à¸´à¸”...</span>
            </div>
            <div class="chat-input-area">
                <textarea id="chat-input" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." rows="1"
                    onkeydown="handleChatKey(event)"></textarea>
                <button class="chat-send-btn" id="chat-send-btn" onclick="sendMessage()">
                    <span>â¤</span>
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â• SETTINGS TAB â•â•â• -->
    <div id="tab-settings" class="tab-content">
        <div class="section-header">
            <h2>âš™ï¸ Settings</h2>
        </div>
        <div class="settings-list">
            <div class="settings-item">
                <span class="label">ğŸ“Š Total Goals</span>
                <span class="value" id="set-total-goals">-</span>
            </div>
            <div class="settings-item">
                <span class="label">âœ… Tasks Completed</span>
                <span class="value" id="set-done-tasks">-</span>
            </div>
            <div class="settings-item">
                <span class="label">ğŸ“ Knowledge Entries</span>
                <span class="value" id="set-kb-count">-</span>
            </div>
            <div class="settings-item">
                <span class="label">ğŸ• Last Updated</span>
                <span class="value" id="set-last-update">-</span>
            </div>
            <div class="settings-item">
                <span class="label">ğŸ¤– System</span>
                <span class="value">NOVA II v2.0</span>
            </div>
        </div>
        <a href="/dashboard/logout" class="logout-btn">ğŸšª à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</a>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" onclick="switchTab('goals')">
            <span class="nav-icon">ğŸ¯</span>
            <span class="nav-label">Goals</span>
        </button>
        <button class="nav-item" onclick="switchTab('kb')">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">KB</span>
        </button>
        <button class="nav-item" onclick="switchTab('chat')">
            <span class="nav-icon">ğŸ’¬</span>
            <span class="nav-label">Chat</span>
        </button>
        <button class="nav-item" onclick="switchTab('settings')">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <script>
        // â”€â”€â”€ State â”€â”€â”€
        let currentTab = 'home';
        let goalsData = [];
        let kbData = [];
        let currentCategoryFilter = 'All';
        let searchTimeout = null;

        let chatLoaded = false;

        // â”€â”€â”€ Tab Switching â”€â”€â”€
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabOrder = ['home', 'goals', 'kb', 'chat', 'settings'];
            document.querySelectorAll('.nav-item')[tabOrder.indexOf(tab)].classList.add('active');

            // Load data on first visit
            if (tab === 'goals' && !document.getElementById('goals-list').querySelector('.goal-card')) {
                loadGoals('goals-list', false);
            }
            if (tab === 'kb' && !document.getElementById('kb-list').querySelector('.kb-card')) {
                loadKB();
            }
            if (tab === 'chat' && !chatLoaded) {
                loadChatHistory();
                chatLoaded = true;
            }
        }

        // â”€â”€â”€ API Calls â”€â”€â”€
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(endpoint);
                if (res.status === 401 || res.status === 302) {
                    window.location.href = '/dashboard/login';
                    return null;
                }
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        }

        // â”€â”€â”€ Load Stats â”€â”€â”€
        async function loadStats() {
            const data = await fetchAPI('/api/stats');
            if (!data || !data.success) return;

            const s = data.stats;
            document.getElementById('stat-goals').textContent = s.active_goals;
            document.getElementById('stat-tasks').textContent = `${s.done_tasks}/${s.total_tasks}`;
            document.getElementById('stat-kb').textContent = s.kb_entries;

            // Settings
            document.getElementById('set-total-goals').textContent = s.total_goals;
            document.getElementById('set-done-tasks').textContent = `${s.done_tasks}/${s.total_tasks}`;
            document.getElementById('set-kb-count').textContent = s.kb_entries;

            const now = new Date();
            document.getElementById('set-last-update').textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        }

        // â”€â”€â”€ Load Goals â”€â”€â”€
        async function loadGoals(containerId, limitToActive = true) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            const data = await fetchAPI('/api/goals');
            if (!data || !data.success) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰à¸„à¹ˆà¸°</p></div>';
                return;
            }

            goalsData = data.goals;
            let goals = goalsData;
            if (limitToActive) {
                goals = goals.filter(g => g.status === 'Active');
            }

            if (goals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ goals à¸„à¹ˆà¸°<br>à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸œà¹ˆà¸²à¸™ LINE à¹„à¸”à¹‰à¹€à¸¥à¸¢!</p></div>';
                return;
            }

            container.innerHTML = goals.map(goal => renderGoalCard(goal)).join('');
        }

        function renderGoalCard(goal) {
            const daysLeft = goal.due_date ? getDaysLeft(goal.due_date) : null;
            const daysText = daysLeft !== null
                ? (daysLeft < 0 ? `â° à¹€à¸¥à¸¢à¸à¸³à¸«à¸™à¸” ${Math.abs(daysLeft)} à¸§à¸±à¸™`
                    : daysLeft === 0 ? 'â° à¸„à¸£à¸šà¸à¸³à¸«à¸™à¸”à¸§à¸±à¸™à¸™à¸µà¹‰!'
                        : `â° à¸­à¸µà¸ ${daysLeft} à¸§à¸±à¸™`)
                : '';

            const urgencyClass = goal.urgency || 'normal';
            const urgencyLabels = { normal: 'On Track', warning: 'Soon', urgent: 'Urgent', overdue: 'Overdue' };

            const tasksHTML = (goal.tasks || []).map(task => {
                const statusClass = task.status === 'Done' ? 'done' : task.status === 'In Progress' ? 'in-progress' : 'todo';
                const statusIcon = task.status === 'Done' ? 'âœ“' : task.status === 'In Progress' ? 'â–¶' : '';
                const nameClass = task.status === 'Done' ? 'done' : '';
                const dueText = task.due_date ? formatDate(task.due_date) : '';

                return `<div class="task-item">
                <div class="task-status-icon ${statusClass}">${statusIcon}</div>
                <span class="task-name ${nameClass}">${escapeHTML(task.name)}</span>
                ${dueText ? `<span class="task-due">${dueText}</span>` : ''}
            </div>`;
            }).join('');

            return `<div class="goal-card" onclick="toggleGoal(this)">
            <div class="goal-header">
                <span class="goal-name">${escapeHTML(goal.name)}</span>
                <span class="urgency-badge ${urgencyClass}">${urgencyLabels[urgencyClass]}</span>
            </div>
            <div class="goal-meta">
                ${goal.due_date ? `<span>ğŸ“… ${formatDate(goal.due_date)}</span>` : ''}
                <span>${daysText}</span>
                <span>ğŸ“Œ ${goal.status}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${goal.progress}%"></div>
            </div>
            <div class="progress-text">${goal.tasks_done}/${goal.tasks_total} tasks completed Â· ${goal.progress}%</div>
            ${goal.tasks && goal.tasks.length > 0 ? `
                <div class="expand-indicator">â–¼ à¸”à¸¹ tasks (${goal.tasks_total})</div>
                <div class="task-list">${tasksHTML}</div>
            ` : ''}
        </div>`;
        }

        function toggleGoal(el) {
            el.classList.toggle('expanded');
        }

        // â”€â”€â”€ Load KB â”€â”€â”€
        async function loadKB() {
            const container = document.getElementById('kb-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            const search = document.getElementById('kb-search').value;
            const params = new URLSearchParams();
            if (currentCategoryFilter !== 'All') params.set('category', currentCategoryFilter);
            if (search) params.set('search', search);

            const data = await fetchAPI(`/api/kb?${params}`);
            if (!data || !data.success) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰à¸„à¹ˆà¸°</p></div>';
                return;
            }

            kbData = data.entries;

            // Update filter pills
            const filterContainer = document.getElementById('kb-filters');
            const categories = ['All', ...(data.categories || [])];
            filterContainer.innerHTML = categories.map(cat =>
                `<button class="pill ${cat === currentCategoryFilter ? 'active' : ''}" onclick="filterKB('${cat}')">${cat}</button>`
            ).join('');

            if (kbData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>à¹„à¸¡à¹ˆà¸à¸šà¹‚à¸™à¹‰à¸•à¸„à¹ˆà¸°</p></div>';
                return;
            }

            container.innerHTML = kbData.map(entry => renderKBCard(entry)).join('');
        }

        function renderKBCard(entry) {
            const catClass = (entry.category || 'other').toLowerCase();
            return `<div class="kb-card" onclick="this.classList.toggle('expanded')">
            <div class="kb-header">
                <span class="kb-title">${escapeHTML(entry.title)}</span>
                <span class="category-badge ${catClass}">${escapeHTML(entry.category || 'Other')}</span>
            </div>
            <div class="kb-content">${escapeHTML(entry.content || '')}</div>
            <div class="kb-date">ğŸ• ${formatDateTime(entry.created_at)}</div>
        </div>`;
        }

        function filterKB(category) {
            currentCategoryFilter = category;
            loadKB();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadKB(), 300);
        }

        // â”€â”€â”€ Helpers â”€â”€â”€
        function getDaysLeft(dateStr) {
            const due = new Date(dateStr);
            const now = new Date();
            return Math.ceil((due - now) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // â”€â”€â”€ Chat Functions â”€â”€â”€
        async function loadChatHistory() {
            const container = document.getElementById('chat-messages');
            const data = await fetchAPI('/api/chat/history');
            if (!data || !data.success || !data.messages || data.messages.length === 0) return;

            // Clear welcome message
            container.innerHTML = '';

            // Messages come newest-first from API, reverse for chronological display
            const messages = data.messages.reverse();
            messages.forEach(msg => {
                container.appendChild(createMessageBubble(msg.role, msg.message, msg.created_at));
            });
            scrollToBottom();
        }

        function createMessageBubble(role, text, timestamp) {
            const wrapper = document.createElement('div');
            wrapper.className = `chat-bubble-wrapper ${role === 'user' ? 'user' : 'nova'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'user' : 'nova'}`;
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'chat-time';
            time.textContent = timestamp ? formatChatTime(timestamp) : 'just now';

            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            return wrapper;
        }

        function formatChatTime(dateStr) {
            const d = new Date(dateStr);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'à¸•à¸­à¸™à¸™à¸µà¹‰';
            if (diffMins < 60) return `${diffMins} à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} à¸Šà¸¡.à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§`;

            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const container = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('chat-send-btn');

            // Clear welcome if present
            const welcome = container.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            // Add user bubble
            container.appendChild(createMessageBubble('user', message));
            input.value = '';
            autoResizeInput();
            scrollToBottom();

            // Show typing indicator
            document.getElementById('typing-indicator').style.display = 'flex';
            document.getElementById('chat-status').textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸„à¸´à¸”...';
            document.getElementById('chat-status').classList.add('thinking');
            sendBtn.disabled = true;
            input.disabled = true;
            scrollToBottom();

            // Send to API
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (res.status === 401 || res.status === 302) {
                    window.location.href = '/dashboard/login';
                    return;
                }

                const data = await res.json();

                // Hide typing
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('chat-status').textContent = 'Online';
                document.getElementById('chat-status').classList.remove('thinking');

                if (data.success) {
                    container.appendChild(createMessageBubble('assistant', data.reply, data.timestamp));
                } else {
                    container.appendChild(createMessageBubble('assistant', 'âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸„à¹ˆà¸°: ' + (data.error || 'Unknown error')));
                }
            } catch (e) {
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('chat-status').textContent = 'Online';
                document.getElementById('chat-status').classList.remove('thinking');
                container.appendChild(createMessageBubble('assistant', 'âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰à¸„à¹ˆà¸°'));
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
                scrollToBottom();
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeInput() {
            const input = document.getElementById('chat-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }

        // Auto-resize on input
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) chatInput.addEventListener('input', autoResizeInput);
        });

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }

        // â”€â”€â”€ Refresh â”€â”€â”€
        async function refreshData() {
            await Promise.all([loadStats(), loadGoals('home-goals', true)]);
            if (currentTab === 'goals') await loadGoals('goals-list', false);
            if (currentTab === 'kb') await loadKB();
        }

        // â”€â”€â”€ Init â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadGoals('home-goals', true);
        });
    </script>
</body>

</html>